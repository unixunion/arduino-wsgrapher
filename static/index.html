<!DOCTYPE HTML>
<html>
  <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, user-scalable=no, maximum-scale=1, minimum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
<head>

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="/css/materialize.min.css"  media="screen,projection"/>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  
	<script type="text/javascript">
  
  // list of charts
  var charts = [];
  
  // counter
  var chartCount = 0;
  
  var data_lock = false;
  
  // refresh rate of all charts
  var refresh_rate = 20;
  // max graph and cache length in samples
  var dataLength = 120;
  
  // holder for refresh_history
  var refresh_history; 
  
  // set the history length to n elements
  var set_history = function(d)
  {
    app_status("Set History to " + d);
    console.log("setting dataLength to " + d);
    if (d > dataLength) {
      console.log("calling refresh history");
      dataLength = d;
      refresh_history();
    }
    dataLength = d;
  }
  
  // common method to update all charts on the page
  var chart_clear = function() {
    app_status("Clearing Charts");
    var i = 0;
    for (var c in charts) {
      charts[i].clear();
      i++;
    };
  };
  
  // common method to update all charts on the page
  var chart_update = function(y) {
    var i = 1;
    // we lock y[i] and c together, since we always want to update the same number of charts, with the same number of values ( for now )
    // this gets tricky for multi value graphs
    for (var c in charts) {
      // push the time from y[0] and value from y[i]
      charts[i-1].update(y[0], y[i]);
      i++;
    };
  };
  
  var app_status = function(msg) {
    // notify user
    // var ni = document.getElementById('status');
    // ni.innerHTML = msg;
    Materialize.toast(msg, 4000)
  };
  
	window.onload = function () {
    console.log("window onload");
    app_status("Ready");
  };
  
	</script>

   
  <!--<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>-->
  <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/js/materialize.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
	<script type="text/javascript" src="/js/canvasjs.min.js"></script>
  <script type="text/javascript" src="/js/zchart.js"></script>
  <script type="text/javascript" charset="utf-8">
          $(document).ready(function(){
              namespace = '/stream';
              
              // just a socket.io
              var socket = io.connect('http://' + document.domain + ':' + location.port + namespace, {
                'reconnection delay': 1000,
                'max reconnection attempts': Infinity
              });
              
              // lock, clear, request-refresh
              refresh_history = function()
              {
                app_status("Disabling Realtime Data");
                console.log("calling chart_clear");
                data_lock = true; // lock to prevent timeline contamination during refresh
                chart_clear();
                
                console.log("sending socket request for refresh");
                app_status("Request Timeline Refresh");
                socket.emit('refresh', {data: 'hit me'});
              }
              
              // connect event
              socket.on('connect', function() {
                console.log("connect")
                
                // delete all graphs, this could only fire if config changed. TODO FIXME
                var node = document.getElementById('charts');
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
                // reset some vars
                charts = [];
                chartCount = 0;
                
                // notify user
                app_status('Connecting...');
                
                // request config
                console.log("request chart config");
                socket.emit('chart config', {data: 'hit me'});
              });
              
              
              socket.on('chart config error', function() {
                console.log('chart config error');
                app_status('Chart Config Error...');
                socket.socket.disconnect();
                socket.socket.reconnect();
                socket.emit('chart config', {data: 'hit me'});
              });
              
              socket.on('reconnect', function(msg) { console.log('reconnect')});
              socket.on('connecting', function(msg) { console.log('connecting')});
              socket.on('reconnecting', function(msg) { 
                app_status('Reconnecting...');
                socket.socket.reconnectionDelay /= 2
                console.log('reconnecting ' + msg)
              });
              socket.on('connect_failed', function(msg) { console.log('connect_failed')});
              socket.on('reconnect_failed', function(msg) { console.log('reconnect_failed')}); 
              socket.on('close', function(msg) { console.log('close')});
              socket.on('disconnect', function(msg) { console.log('disconnect')});
              
              // data handler for chart data, chart data is a list [v1, v2, v3]
              socket.on('chart data', function(msg) {
                if (!data_lock)
                {
                  chart_update(msg.data);
                }
              });
              
              // separate handler for refresh data, do stop timeline sequence errors.
              socket.on('chart refresh data', function(msg) {
                  chart_update(msg.data);
              });
              
              // the chart refresh complete event turns off the data_lock
              socket.on('chart refresh complete', function(msg) {
                app_status("Enabling Realtime Data");
                console.log("refresh complete, unlocking data_lock");
                data_lock = false;
              });
              
              
              // data handler for chart config
              /*
              
              chart config data:
              
              { 
                number: 4, // number of graphs to create
                titles: ['volts', 'dust', 'raw', 'something else'] // titles for graphs
              }
              
              */
              socket.on('chart config', function(msg) {
                  console.log('chart config event');
                  console.log(msg.data);
                  app_status("Received Chart Config")
                  
                  // start from position 2, since 1 is the time index
                  var i = 2;
                  while (i<=msg.data['number']+1)
                  {
                    console.log("Creating chart " + (i-1) );
                    console.log(typeof(msg.data['titles'][i-1]));
                    if ( typeof(msg.data['titles'][i-2]) != 'undefined' )
                    {
                      charts.push(new ZChart(msg.data['titles'][i-2], dataLength));
                    } else {
                      charts.push(new ZChart("value " + i, dataLength));
                    }
                    i++;
                  }
                  // request graph data refresh if server supports it.
                  app_status('Requesting Data Refresh...');
                  socket.emit('refresh', {data: 'hit me'});
              });
              
          });
      </script>
  
</head>
<body>

  <div class="navbar-fixed">
  <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo right">Reapy</a>
        <ul id="nav-mobile" class="left hide-on-med-and-down">
          <li><a href="sass.html">Sass</a></li>
          <li><a href="components.html">Components</a></li>
          <li><a href="javascript.html">JavaScript</a></li>
        </ul>
      </div>
      <ul>
      <a class="waves-effect waves-circle waves-light btn-floating secondary-content" onclick="set_history(600)">10m</a>
      <a class="waves-effect waves-circle waves-light btn-floating secondary-content" onclick="set_history(120)">2m</a>
      </ul>
    </nav>
  </div>

  <div class="container">
    
    
    <!-- <div class="card-panel card-reveal">
      <span id="status" class="blue-text text-darken-2"></span>
    </div> -->
        
    <div id="charts" >
    </div>
    
  </div>
</body>
</html>