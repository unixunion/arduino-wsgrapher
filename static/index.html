<!DOCTYPE HTML>
<html>
<head>

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="/css/materialize.min.css"  media="screen,projection"/>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  
	<script type="text/javascript">
  
  var charts = []; // chart list
  var chartCount = 0; // chart counter
  var data_lock = false; // used to lock chart data while refreshing
  var refresh_rate = 1000; // render rate of charts
  var dataLength = 120; // default graph length
  var refresh_history; // pointer for refresh_history
  
  // set the history length to n elements
  var set_history = function(d)
  {
    app_status("Set History to " + d);
    console.log("setting dataLength to " + d);
    if (d > dataLength) {
      console.log("new length > old length, calling refresh history");
      dataLength = d;
      refresh_history();
    }
    dataLength = d;
  }
  
  // common method to clear all charts data points
  var chart_clear = function() {
    app_status("Clearing Charts");
    var i = 0;
    for (var c in charts) {
      charts[i].clear();
      i++;
    };
  };
  
  // common method to update all charts on the page
  var chart_update = function(y) {
    var i = 1;
    // we lock y[i] and c together, since we always want to update the same number of charts, with the same number of values ( for now )
    // this gets tricky for multi value graphs
    for (var c in charts) {
      // push the time from y[0] and value from y[i]
      charts[i-1].update(y[0], y[i]);
      i++;
    };
  };
  
  // notify user of events in UI
  var app_status = function(msg) {
    Materialize.toast(msg, 2500)
  };
  
	window.onload = function () {
    console.log("window onload");
    app_status("Ready");
  };
  
	</script>

   
  <!--<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>-->
  <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/js/materialize.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
	<script type="text/javascript" src="/js/canvasjs.min.js"></script>
  <script type="text/javascript" src="/js/zchart.js"></script>
  <script type="text/javascript" charset="utf-8">
          $(document).ready(function(){
              namespace = '/stream';
              
              // just a socket.io
              var socket = io.connect('http://' + document.domain + ':' + location.port + namespace, {
                'reconnection delay': 1000,
                'max reconnection attempts': Infinity
              });
              
              // lock, clear, request-refresh
              refresh_history = function()
              {
                // app_status("Disabling Realtime Data");
                console.log("locking and calling chart_clear");
                data_lock = true; // lock to prevent timeline contamination during refresh
                chart_clear();
                
                console.log("request for refresh");
                app_status("Requesting Refresh");
                socket.emit('refresh', {data: 'hit me'});
              }
              
              // connect event
              socket.on('connect', function() {
                console.log("connect")
                app_status("Socket.IO Connect");
                
                // delete all graphs, this could only fire if config changed. TODO FIXME
                var node = document.getElementById('charts');
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
                // reset some vars
                charts = [];
                chartCount = 0;
                
                // request config
                console.log("request chart config");
                socket.emit('chart config', {data: 'hit me'});
              });
              
              
              // the server emits a config error if chart information is unknown
              socket.on('chart config error', function() {
                console.log('chart config error');
                app_status('Chart Config Error...');
                socket.socket.disconnect();
                socket.socket.reconnect();
                socket.emit('chart config', {data: 'hit me'});
              });
              
              
              // on reconnecting event, we set the reconnectionDelay to a non-exponential useless value.
              socket.on('reconnecting', function(msg) { 
                app_status('Reconnecting...');
                socket.socket.reconnectionDelay /= 2
                console.log('reconnecting ' + msg)
              });
              
              
              // data handler for chart data, chart data is a list [v1, v2, v3]
              socket.on('chart data', function(msg) {
                if (!data_lock)
                {
                  chart_update(msg.data);
                }
              });
              
              // separate handler for refresh data, do stop timeline sequence errors.
              socket.on('chart refresh data', function(msg) {
                  chart_update(msg.data);
              });
              
              // the chart refresh complete event turns off the data_lock
              socket.on('chart refresh complete', function(msg) {
                app_status("Refresh Complete");
                console.log("refresh complete, unlocking data_lock");
                data_lock = false;
              });
              
              
              /*
              
              chart config handler
              
              { 
                number: 4, // number of graphs to create
                titles: ['volts', 'dust', 'raw', 'something else'] // titles for graphs
              }
              
              */
              socket.on('chart config', function(msg) {
                  console.log('chart config event');
                  console.log(msg.data);
                  app_status("Received Chart Config")
                  
                  // start from position 2, since 1 is the time index
                  var i = 2;
                  while (i<=msg.data['number']+1)
                  {
                    console.log("Creating chart " + (i-1) );
                    console.log(typeof(msg.data['titles'][i-1]));
                    if ( typeof(msg.data['titles'][i-2]) != 'undefined' )
                    {
                      charts.push(new ZChart(msg.data['titles'][i-2], dataLength));
                    } else {
                      charts.push(new ZChart("value " + i, dataLength));
                    }
                    i++;
                  }
                  socket.emit('refresh', {data: 'hit me'});
              });
              
              
              // some method hooks for future
              socket.on('reconnect', function(msg) { app_status("Socket.IO Reconnect")});
              socket.on('connecting', function(msg) { app_status("Socket.IO Connecting")});
              socket.on('connect_failed', function(msg) { app_status("Socket.IO Connect Failed")});
              socket.on('reconnect_failed', function(msg) { app_status("Socket.IO Reconnect Failed")}); 
              socket.on('close', function(msg) { app_status("Socket.IO Close")});
              socket.on('disconnect', function(msg) { app_status("Socket.IO Disconnect")});
              
          });
      </script>
  
</head>
<body>

  <div class="navbar-fixed">
  <nav>
      <div class="nav-wrapper">
        
        <!-- <div class="brand-logo right mdi-device-signal-cellular-connected-no-internet-0-bar"></div> -->
        
        <!--hide-on-med-and-down -->
        
        <!-- <div class="preloader-wrapper medium active right">
        <div class="spinner-layer spinner-blue-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div><div class="gap-patch">
                <div class="circle"></div>
              </div><div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
        </div> -->
        
        
        <ul id="nav-fixed" class="left">
          <li><a class='dropdown-button' href='#' data-activates='history'><i class="mdi-action-history"></i></a></li>
          <li><a class="right"><i class="mdi-action-help"></i></a></li>
          <ul id='history' class='dropdown-content'>
            <li><a href="#!" onclick="set_history(120)">2m</a></li>
            <li><a href="#!" onclick="set_history(600)">10m</a></li>
            <li class="divider"></li>
            <li><a href="#!" onclick="set_history(1800)">30m</a></li>
          </ul>
        </ul>
      </div>
    </nav>
  </div>

  <div>
    
    
    <!-- <div class="card-panel card-reveal">
      <span id="status" class="blue-text text-darken-2"></span>
    </div> -->
      
    <!-- <div id="progress" class="progress">
        <div id="spinner" class="indeterminate"></div>
    </div> -->
        
    <div id="charts" class="row" >
      
    </div>
    
    <footer class="page-footer hide-on-med-and-down">
     
      <div class="container">
       <div class="row">
         <div class="col l6 s12">
           <h5 class="white-text">Footer Content</h5>
           <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
         </div>
         <div class="col l4 offset-l2 s12">
           <h5 class="white-text">Links</h5>
           <ul>
             <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
             <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
             <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
             <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
           </ul>
         </div>
       </div>
      </div>
     
      <div class="footer-copyright">
        <div class="container">
          Â© 2015 Copyright Psimax Aerospace
          <a class="grey-text text-lighten-4 right" href="#!">About</a>
        </div>
      </div>
      
    </footer>
    
  </div>
</body>
</html>