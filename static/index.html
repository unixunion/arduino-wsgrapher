<!DOCTYPE HTML>
<html>

<head>
	<script type="text/javascript">
  
  // list of charts
  var charts = [];
  // counter
  var chartCount = 0;
  
  // refresh rate of all charts
  var refresh_rate = 20;
  // max graph and cache length in samples
  var dataLength = 120;
  
  // common method to update all charts on the page
  var chart_update = function(y) {
    var i = 0;
    // we lock y[i] and c together, since we always want to update the same number of charts, with the same number of values ( for now )
    // this gets tricky for multi value graphs
    for (var c in charts) {
      charts[i].update(y[i]);
      i++;
    };
  };
  
  
	window.onload = function () {
    console.log("window onload");
  };
  
	</script>
  <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
	<script type="text/javascript" src="/js/canvasjs.min.js"></script>
  <script type="text/javascript" src="/js/zchart.js"></script>
  <script type="text/javascript" charset="utf-8">
          $(document).ready(function(){
              namespace = '/stream';
              
              var socket = io.connect('http://' + document.domain + ':' + location.port + namespace, {
                'reconnection delay': 1000,
                'max reconnection attempts': Infinity
              });
              
              // on connect, request a config
              socket.on('connect', function() {
                console.log("connect")
                
                // clear the scene
                var node = document.getElementById('charts');
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
                
                // reset some vars
                charts = [];
                chartCount = 0;
                
                // request config
                console.log("request chart config");
                socket.emit('chart config', {data: 'hit me'});
              });
              
              
              socket.on('chart config error', function() {
                console.log('chart config error');
                socket.socket.disconnect();
                socket.socket.reconnect();
                socket.emit('chart config', {data: 'hit me'});
              });
              
              socket.on('reconnect', function(msg) { console.log('reconnect')});
              socket.on('connecting', function(msg) { console.log('connecting')});
              socket.on('reconnecting', function(msg) { 
                socket.socket.reconnectionDelay /= 2
                console.log('reconnecting ' + msg)
              });
              socket.on('connect_failed', function(msg) { console.log('connect_failed')});
              socket.on('reconnect_failed', function(msg) { console.log('reconnect_failed')}); 
              socket.on('close', function(msg) { console.log('close')});
              socket.on('disconnect', function(msg) { console.log('disconnect')});
              
              // data handler for chart data, chart data is a list [v1, v2, v3]
              socket.on('chart data', function(msg) {
                  //console.log('Received #' + msg.count + ': ' + msg.data);
                  chart_update(msg.data);
              });
              
              // data handler for chart config
              socket.on('chart config', function(msg) {
                  console.log('chart config event: ' + msg.data);
                  var i = 1;
                  while (i<=msg.data)
                  {
                    charts.push(new ZChart("value " + i, dataLength));
                    i++;
                  }
                  // request graph data refresh if server supports it.
                  socket.emit('refresh', {data: 'hit me'});
              });
              
          });
      </script>
  
</head>
<body>
  <div id="charts">
    <div id="log"></div>
  </div>
  
</body>
</html>